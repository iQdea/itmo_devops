## **Gitlab CI: Пайплайн сборки докер-приложения**

Репозитории с лабораторной работой:
- App - https://gitlab.com/devops_alpha_beta/repositories/lab-7-app
- CI - https://gitlab.com/devops_alpha_beta/repositories/lab-7-ci

Цель лабораторной: Написать пайплайн, для автоматической сборки и публикация докер-образов при изменении кода продукта

1. Задачи работы с докером должны быть универсальными для любого проекта и вынесены в отдельный репозиторий как модуль
   => вынесены в lab7-ci
2. Задачи должны параметризоваться динамическими переменными гитлаба
   => параметризуется переменными гитлаба во всех файлах
3. Сборка должна выполняться при условии, что менялись файлы продукта
   => Условия сборки прописаны в .gitlab-ci.yml
4. При использовании мультистейджа в сборке докерфайлов, каждый этап сборки должен выполняться только при изменении зависимых файлов
   => Условия сборки прописаны в .gitlab-ci.yml, есть файл multilayer.yml в lab-7-ci для сборки для каждого из стейджей

Был использован локальный раннер для пайплайнов как docker контейнер на WSL
Инструкция:
1. Выполнить команду `docker run -d --name gitlab-runner --restart always \
  -v /srv/gitlab-runner/config:/etc/gitlab-runner \
  -v /var/run/docker.sock:/var/run/docker.sock \
  gitlab/gitlab-runner:latest`
2. Выполнить команду `docker exec -it gitlab-runner gitlab-runner register`:
   1. Зайти в gitlab => project => settings => CI/CD
   2. Expand раздел Runners
   3. Скопировать ссылку и токен
   4. В register начнется выполнение регистрации инстанса 
   5. Введите ссылку из пункта 3
   6. Введите токен из пункта 3
   7. Ввведите произвольное описание
   8. Ввведите gitlab-builder в теги
   9. Ввод maitenance note оставьте пустым, нажав Enter
   10. В executor введите docker
   11. В дефолтный образ введите docker:latest
   12. Регистрация закончена, в разделе runners вы увидите ваш новый раннер
   13. Нажмите на редактирование и поставьте галочку в Run untagged jobs и сохраните изменения
3. Перейдите в каталог с конфигурационным файлом: cd /srv/gitlab-runner/config
4. Откройте config.toml и измените секцию volumes в вашем раннере на volumes = ["/cache", "/var/run/docker.sock:/var/run/docker.sock"]
5. Перезапустите контейнер: docker restart gitlab-runner
Готово, теперь локальный раннер настроен и можно выполнять пайпланы с использованием локального раннера